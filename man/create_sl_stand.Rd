% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/create_sl_stand.R
\name{create_sl_stand}
\alias{create_sl_stand}
\title{Create a rectangular virtual stand from a tree inventory}
\usage{
create_sl_stand(
  trees_inv,
  cell_size,
  latitude,
  slope,
  aspect,
  north2x,
  sensors = NULL,
  core_polygon_df = NULL,
  aarect_zone = FALSE,
  fill_around = FALSE,
  verbose = TRUE
)
}
\arguments{
\item{trees_inv}{A data.frame with one row per tree.
See \link{check_inventory} for the required structure and validated columns.}

\item{cell_size}{Numeric. Side length of square cells composing the stand (meters).}

\item{latitude}{Numeric, latitude of the stand (degrees)}

\item{slope}{Numeric. Slope of the plot (degrees).}

\item{aspect}{Numeric. Aspect of the slope, defined as the azimuth of the
downslope direction, clockwise from North (degrees).
North = 0, East = 90, South = 180, West = 270.}

\item{north2x}{Numeric. Clockwise angle from North to the X-axis (degrees).
A value of 0 corresponds to a Y-axis oriented toward North.}

\item{sensors}{Optional data.frame defining position and height of the sensor within the stand.
See \link{check_sensors} for the required structure and validated columns.}

\item{core_polygon_df}{Optional data.frame defining the core inventory polygon.
Must contain columns \code{x} and \code{y}. If \code{NULL}, a concave hull
is automatically computed from tree positions.}

\item{aarect_zone}{Logical. If \code{TRUE}, the inventory zone is defined
by the minimum-area enclosing rectangle of the core polygon with minimum rotation to
obtain an axis-aligned rectangle inventory zone.
If \code{FALSE}, the core polygon itself is used.}

\item{fill_around}{Logical. If \code{TRUE}, trees are added outside the core
polygon until the basal area per hectare of the full stand matches that
of the core inventory.}

\item{verbose}{Logical. If \code{TRUE} (default), messages and warnings are
printed during processing. If \code{FALSE}, output is silent.}
}
\value{
A named list with the following elements:
\describe{
\item{\code{trees}}{
Data.frame of the final tree inventory, including added trees if
\code{fill_around = TRUE}.
The structure matches the inventory format validated by
\link{check_inventory}, with additional derived variables required
for ray tracing. A logical column \code{added_to_fill} indicates whether
each tree originates from the initial inventory or was added to fill
around the inventory zone.
}
\item{\code{core_polygon}}{
List describing the inventory zone:
\itemize{
\item \code{df}: data.frame of polygon vertices
\item \code{sf}: corresponding \code{sf} POLYGON
\item \code{aarect_zone}: did we used an axis-aligned rectangle inventory zone ?
}
}
\item{\code{transform}}{
List of transformation and filling information, including core area,
target and final basal area, number of added trees, and applied spatial transformations
}
\item{\code{geometry}}{
List describing stand geometry and terrain parameters
(cell size, number of cells, slope, aspect, and orientation).
}
}
}
\description{
This function builds a rectangular (or square) virtual forest stand from a
user-provided tree inventory. Trees are spatially shifted so that the
inventory zone is centered within a regular grid of square cells.
Optionally, additional trees can be added around the core inventory area
to match its basal area per hectare.
}
\details{
The function supports sloping terrain and coordinate system rotation, and
returns a fully prepared stand ready for use in the ray-tracing pipeline
(see \link{run_sl}).

The returned \code{trees} data.frame conforms to the inventory format checked
by \link{check_inventory}, with the following controlled modifications:
\itemize{
\item Tree vertical position \code{z} is computed from terrain slope and aspect.
\item Crown maximum radius height \code{hmax_m} is computed when fixed by crown
geometry conventions:
\itemize{
\item \code{"P"} and \code{"4P"}: \code{hmax_m = hbase_m}
\item \code{"E"} and \code{"4E"}: \code{hmax_m = hbase_m + 0.5 * (h_m - hbase_m)}
}
For crown types \code{"2E"} and \code{"8E"}, \code{hmax_m} must be provided by the user.
\item If missing, column \code{dbh_cm} is added and filled with \code{NA}.
\item If missing, crown interception properties (e.g. \code{crown_openness},
\code{crown_lad}) are added using default values.
}

All input data.frames (\code{trees_inv}, \code{sensors}, and \code{core_polygon_df}) are
automatically checked for coordinate type:
\itemize{
\item If \code{x} and \code{y} columns exist, they are assumed to be planar.
\item If \code{lon} and \code{lat} columns exist, they are converted into
planar UTM coordinates automatically using \code{create_xy_from_lonlat()}.
\item The UTM projection (EPSG) is determined from the mean coordinates of
\code{trees_inv}. All inputs must share the same EPSG; otherwise, the
function stops with an error. If conversion occurred, the epsg is stored in the output.
}

The function ensures that all trees fall within the core inventory polygon,
applying small buffers if necessary to handle numerical precision issues.
Invalid polygons are automatically repaired when possible.

When \code{fill_around = TRUE}, trees are randomly sampled from the original
inventory and positioned outside the core polygon until the target basal area
per hectare is reached for the full rectangular stand.
}
\examples{
\dontrun{
data_prenovel <- SamsaRaLight::data_prenovel
trees_inv <- data_prenovel$trees

stand <- create_sl_stand(
  trees_inv = trees_inv,
  cell_size = 5,
  latitude = 46,
  slope = 10,
  aspect = 180,
  north2x = 0,
  aarect_zone = TRUE,
  fill_around = FALSE,
  verbose = TRUE
)

head(stand$trees)
}

}
