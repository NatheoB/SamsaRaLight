---
output: github_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# SamsaRaLight

The goal of SamsaRaLight is to estimate the light intercepted by a tree
and the light on the ground in a given forest stand.

It uses the ray tracing model SamsaraLight (Courbaud et al. 2003, 2015)
to compute the direct and diffuse rays within a given period of a year,
at a given latitude. Then, it simulates the ray coming from the sky
towards cells of the plot and it computes the interception of all the
rays by each consecutive tree crowns with given dimensions.

The SamsaraLight model was initially implemented within the Java
platform Capsis (<https://capsis.cirad.fr/capsis/help_en/samsaralight>).
However, for the sake of fast computing and easier use within R
paradigm, we needed to reformulate the model as an R package and we used Rcpp with 
C++ script for fast computing.


## Installation

You can install the development version of SamsaRaLight from
[GitHub](https://github.com/) with:

``` r
install.packages("devtools")
devtools::install_github("NatheoB/SamsaRaLight")
```

## Applied tutorials

You can find simple examples as tutorial for different stand situations and with different tree crown dimensions accuracy:

1. Compute light interception with simplified symmetric crowns
2. Consider interception of light by trunks
3. Complexify crown representation with irregular crowns


## Inputs

### Stand geometry

You first need to consider the geometry of the stand as argument of the `sl_run()` function.


You will need the `latitude` of the plot (Y-coordinate in WGS84 system) for computation of angle and azimuth of each diffuse and direct rays.


The forest stand is defined as a flat plane with a given :

- `slope` (uniform slope in degrees of the flat plane)

- `aspect` (Angle of slope bottom on the compass from the North, clockwise rotation in degrees. northern aspect = 0, eastern aspect = 90, southern aspect = 180, western aspect = 270)

- `north_to_x_cw` (Angle from North to x axis clockwise in degrees, the default 90 value corresponds to a Y axis oriented toward the North)


You need to define the size of the plot by setting the size (`cell_size`) and the number of cells composing the plot (`n_cells_x` and `n_cells_x`, respectively the number of cells in a column and a row).

All the diffuse and direct rays are launch towards the center of each cell with a computed azimuth and angle. Then, the more cells there are in the plot, the more rays will be launched (but with an energy proportional to the total energy of the month), and the longer the calculation time will be.


### Trees description

Then, you need to provide a well formatted data.frame containing description of each tree of the plot.

The trees data.frame should contain all the below variables, with the
correct name and type of the column:

-   `id_tree`: Unique id of the tree (integer)

-   `x`, `y`: Relative location of the tree in the stand (double, in m)

-   `crown_type`: Type of the crown form. Between "E" and "P" for symmetric crown 
    (see tutorial n°1). Between "2E", "8E" or "4P" for irregular crowns (see tutorial n°3)
    (character)

-   `dbh_cm`: Diameter at breast height (1.30m) of the trunk of the tree
    (double, in cm) 
    (Can be set to NA if one do not consider light interception by trunks,
    otherwise, see tutorial n°2)

-   `h_m`: Height of the top of the tree crown from the ground (double, in m)

-   `hbase_m`: Height of the tree crown base (double, in m)

-   `hmax_m`; Height at which the tree crown diameter is the biggest (double, in m)

-   `rn_m`, `rs_m`, `re_m`, `rw_m`: Tree crown radius at hmax towards respectively 
    North, South, East and West (in m, double). 

-   `crown_lad`: Leaf Area Density of the tree crown (in m2/m3) (i.e.
    surface of leave per volume of crown, considering an homogeneous
    crown). (Used when computing interception with a crown considered as
    a turbid medium, i.e argument turbid_medium = TRUE, can be set to NA otherwise). (double)

-   `crown_openess`: Crown Openness of the tree (no unit) (i.e. Fraction of
    the energy of a light ray crossing the crown that is intercepted).
    (Used when computing interception with a crown considered as a porous
    envelop, i.e argument turbid_medium = FALSE, can be set to NA otherwise). (double)


### Monthly radiation

You will also need to provide a data.frame to that indicates the monthly radiations.
You need to provide three columns with 12 rows, each indicating radiations for a month:

-   `month`: the month between 1 and 12

-   `Hrad`: monthly global radiation on a horizontal plane in MJ.m^2

-   `DGratio`: ratio of monthly diffuse energy to global energy (needed
    to compute direct energy)

You can fetch this data.frame for a given `latitude` and `longitude` using the
function `get_monthly_rad()`. It fetches monthly data between given
start and end year (range between 2005 and 2020) from the PVGIS database
<https://joint-research-centre.ec.europa.eu/pvgis-photovoltaic-geographical-information-system_en>.
Here, you can choose to average the monthly values between all the years
between 2005 and 2020 or to choose values of a given year.


## Outputs

The function returns a list with two data.frames:

`trees`: Light interception for each tree

-   `epot`: Potential energy intercepted by the tree without its
    neighbours (in MJ/year)

-   `e`: Energy intercepted by the tree when considering competition
    with neighbours (in MJ/year)


`cells`: Light coming to each cell of the plot

-   `e`: Total energy arriving to the cell (in MJ/year)

-   `erel`: Relative energy coming to the cell compared to the one above
    canopy. It ranges from 0 (no light on the ground) to 1 (no energy
    has been intercepted by above trees).



## Speed analysis

You can find here a comparison of speed between R-based and Capsis-based SamsaraLight for different degree of stand complexity and sizes.


