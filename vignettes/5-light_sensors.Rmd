---
title: "Tutorial 5 - Light sensors"
subtitle: "Calibrate species' leaf area density from light sensors"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Tuto5 - light sensors}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)
```
  
  
```{r example, message=FALSE, warning=FALSE}
library(SamsaRaLight)
library(dplyr)
library(ggplot2)
library(ggforce)
library(tidyr)
library(grid)
```


```{r}
# Set seed for randomization reproducibility
set.seed(5030)
```


# Inventory info

Test on IRRES1 inventory with all trees having a LAD of 0.5

```{r stand_geom}
# It is an uneven-aged mixed stand in Belgium with irregular crowns
data_trees <- SamsaRaLight::data_trees_irres1
data_rad <- SamsaRaLight::data_rad_irres1

core_polygon_df <- data.frame(
  x = c(263193.1, 263168.5, 263045.3, 263070),
  y = c(114310.3, 114237.4, 114279, 114351.9)
)

# Coordinates of the stand (for monthly radiation and rays geometry)
latitude <- 50.04 # The latitude of the stand (Y-coord in WGS85)
longitude <- 5.2 # The longitude of the plot (X-coord in WGS85)

# The slope of the stand
slope <- 6.49

# Angle of slope bottom on the compass from the North, clockwise rotation (in degrees)
# northern aspect : 0, eastern aspect : 90, southern aspect : 180, western aspect : 270
aspect <- 43.54

# Angle from North to x axis clockwise. (in degrees)
# Default value 90 corresponds to a Y axis oriented toward the North.
north_to_x_cw <- 90
```

```{r}
# Size of a cell (i.e. accuracy of SamsaraLight model)
cell_size <- 10
```


# Shift coordinates and define the rectangal square

```{r}
stand <- SamsaRaLight::create_rect_stand(data_trees, cell_size, 
                                         core_polygon_df = NULL,
                                         use_rect_zone = TRUE,
                                         fill_around = FALSE)
```


# Fill around core polygon and run SamsaraLight

```{r out_samsa}
out_sl <- SamsaRaLight::sl_run(
  stand$trees, data_rad,
  latitude = latitude, slope = slope, 
  aspect = aspect, north_to_x_cw = north_to_x_cw,
  cell_size = stand$info$cell_size, 
  n_cells_x = stand$info$n_cells_x, 
  n_cells_y = stand$info$n_cells_y,
  turbid_medium = TRUE,
  trunk_interception = FALSE
)
```

```{r, fig.dim = c(8, 6)}
plot_stand <- out_sl$output$cells %>% 
  dplyr::mutate(
    pacl_group = case_when(
      pacl > 0.5 ~ "> 50%",
      pacl > 0.25 ~ "25 - 50%",
      pacl > 0.125 ~ "12.5 - 25%",
      pacl > 0.0625 ~ "6.25 - 12.5%",
      pacl <= 0.0625 ~ "< 6.25%"
    ),
    pacl_group = factor(pacl_group,
                        levels = c("< 6.25%", "6.25 - 12.5%",
                                   "12.5 - 25%", "25 - 50%",
                                   "> 50%"))) %>% 
  
  ggplot() +
  
  geom_tile(aes(x = x_center, y = y_center,
                fill = pacl_group), color = "black") +
  scale_fill_grey(start = 0.2, end = 1,
                  drop = FALSE) +
  labs(fill = "Cells enlightment") +
  ggnewscale::new_scale_fill() +
  
  geom_ellipse(data = stand$trees, 
               mapping = aes(x0 = x, y0 = y, 
                             a = (re_m + rw_m) / 2,
                             b = (rn_m + rs_m) / 2,
                             angle = 0,
                             fill = species)) +
  coord_equal() +
  labs(fill = "Species") +
  scale_fill_manual(values = c("skyblue", "salmon", "yellow2", "olivedrab3", "mediumorchid1")) +
  
  scale_x_continuous(breaks = seq(0, stand$info$n_cells_x * stand$info$cell_size,
                                  by = stand$info$cell_size),
                     labels = round(seq(0, stand$info$n_cells_x * stand$info$cell_size,
                                        by = stand$info$cell_size),
                                    digits = 1)) +
  scale_y_continuous(breaks = seq(0, stand$info$n_cells_y * stand$info$cell_size,
                                  by = stand$info$cell_size),
                     labels = round(seq(0, stand$info$n_cells_y * stand$info$cell_size,
                                        by = stand$info$cell_size),
                                    digits = 1)) +
  
  geom_sf(data = stand$inv_zone_sf, inherit.aes = FALSE,
          fill = "yellow", color = "black", alpha = 0.7) +
  
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        legend.position = "right") +
  xlab("") + ylab("")

plot_stand
```

# Look for sensors and run SamsaraLight on them

BE CAREFUL, DO NOT FORGET TO APPLY THE SHIFT TO THE SENSORS COORDINATES

```{r, fig.dim = c(8, 6)}
data_sensors <- data_sensors_irres1 %>% 
  dplyr::mutate(x = x + stand$info$shift_x,
                y = y + stand$info$shift_y)

plot_stand_sensors <- plot_stand +
  geom_rect(data = data_sensors,
            mapping = aes(xmin = x - cell_size/2,
                          ymin = y - cell_size/2,
                          xmax = x + cell_size/2,
                          ymax = y + cell_size/2),
            color = "black", fill = "gray", alpha = 0.5) +
  geom_text(data = data_sensors, 
            mapping = aes(x = x, y = y, label = id_sensor),
            size = 3)

plot_stand_sensors
```

Set detailed output to TRUE because we need PACL in a horizontal plane, whereas the default PACL is in the slope.
Indeed, the sensor is not parallel to the slope, but horizontal.


```{r out_sensors}
out_sensors <- SamsaRaLight::sl_run(
  stand$trees, data_rad,
  sensors = data_sensors, sensors_only = TRUE,
  latitude = latitude, slope = slope, 
  aspect = aspect, north_to_x_cw = north_to_x_cw,
  cell_size = stand$info$cell_size, 
  n_cells_x = stand$info$n_cells_x, 
  n_cells_y = stand$info$n_cells_y,
  turbid_medium = TRUE,
  trunk_interception = FALSE,
  detailed_output = TRUE
)
```


```{r time_sl}
microbenchmark::microbenchmark(
  "sl" = SamsaRaLight::sl_run(
    stand$trees, data_rad,
    sensors = data_sensors, sensors_only = FALSE,
    latitude = latitude, slope = slope, 
    aspect = aspect, north_to_x_cw = north_to_x_cw,
    cell_size = stand$info$cell_size, 
    n_cells_x = stand$info$n_cells_x, 
    n_cells_y = stand$info$n_cells_y,
    turbid_medium = TRUE,
    trunk_interception = FALSE
  ))
```

```{r time_sl_onlysensors}
microbenchmark::microbenchmark(
  "sl" = SamsaRaLight::sl_run(
    stand$trees, data_rad,
    sensors = data_sensors, sensors_only = TRUE,
    latitude = latitude, slope = slope, 
    aspect = aspect, north_to_x_cw = north_to_x_cw,
    cell_size = stand$info$cell_size, 
    n_cells_x = stand$info$n_cells_x, 
    n_cells_y = stand$info$n_cells_y,
    turbid_medium = TRUE,
    trunk_interception = FALSE
  ))
```


# Compare observed with predicted light from field and virtual sensors

```{r, fig.dim = c(8, 6)}
dplyr::left_join(
  data_sensors %>% 
    dplyr::select(id_sensor, pacl, pacl_direct, pacl_diffuse) %>% 
    dplyr::rename_at(vars(-"id_sensor"), ~paste0(., "_obs")),
  out_sensors$sensors %>% 
    dplyr::select(id_sensor, 
                  pacl = pacl_horizontal, 
                  pacl_direct = pacl_horizontal_direct, 
                  pacl_diffuse = pacl_horizontal_diffuse) %>% 
    dplyr::rename_at(vars(-"id_sensor"), ~paste0(., "_pred")),
  by = "id_sensor"
) %>% 
  dplyr::mutate(
    diff_pacl = pacl_obs - pacl_pred,
    diff_pacl_direct = pacl_direct_obs - pacl_direct_pred,
    diff_pacl_diffuse = pacl_diffuse_obs - pacl_diffuse_pred
  ) %>% 
  
  ggplot(aes(y = pacl_pred, x = pacl_obs)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, color = "salmon") +
  geom_abline(intercept = 0, slope = 1, color = "skyblue") +
  xlab("Observed PACL") +
  ylab("Predicted PACL with virtual sensors in SamsaraLight") +
  labs(title = "Comparison between PACL from field sensors and predicted with SamsaraLight",
       subtitle = "red line is a linear regression and blue line is the 1,1 control line for perfect fit") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
```

# A first approach for LAD calibration

Above, the LAD parameter has been set to 0.5. Field sensors can be used to calibrate the tree leaf area density, an important parameter that controls the amount of light arriving on the ground.

To do so, a first approach could be to found a mean species' LAD value that minimize the mean residuals between observed and predicted total PACL.

```{r}
LADs <- seq(0.001, 2, by = 0.001)
```

```{r echo = T, results = 'hide'}
out_residuals <- vector("list", length(LADs))
i <- 0

time_start <- Sys.time()

for (lad in LADs) {
  
  print(lad)
  i <- i+1
  
  # Set the tested LAD value
  inv_test <- stand$trees %>% 
    dplyr::mutate(crown_lad = lad)
  
  # Run SamsaraLight
  out_sensors_test <- SamsaRaLight::sl_run(
    inv_test, data_rad,
    sensors = data_sensors, sensors_only = TRUE,
    latitude = latitude, slope = slope, 
    aspect = aspect, north_to_x_cw = north_to_x_cw,
    cell_size = stand$info$cell_size, 
    n_cells_x = stand$info$n_cells_x, 
    n_cells_y = stand$info$n_cells_y,
    turbid_medium = TRUE,
    trunk_interception = FALSE,
    detailed_output = TRUE
  )
  
  # Compute the mean residuals
  out_residuals[[i]] <- 
    
    dplyr::left_join(
      
      data_sensors %>% 
        dplyr::select(id_sensor, pacl, pacl_direct, pacl_diffuse) %>% 
        dplyr::rename_at(vars(-"id_sensor"), ~paste0(., "_obs")),
      
      out_sensors_test$sensors %>% 
        dplyr::select(id_sensor, 
                      pacl = pacl_horizontal, 
                      pacl_direct = pacl_horizontal_direct, 
                      pacl_diffuse = pacl_horizontal_diffuse) %>% 
        dplyr::rename_at(vars(-"id_sensor"), ~paste0(., "_pred")),
      
      by = "id_sensor"
    ) %>% 
    
    dplyr::mutate(
      res_pacl = pacl_obs - pacl_pred,
      res_pacl_direct = pacl_direct_obs - pacl_direct_pred,
      res_pacl_diffuse = pacl_diffuse_obs - pacl_diffuse_pred
    ) %>% 
    
    dplyr::summarise(across(c(res_pacl, res_pacl_direct, res_pacl_diffuse), mean)) %>% 
    dplyr::mutate(lad = lad) %>% 
    dplyr::select(lad, res_pacl, res_pacl_direct, res_pacl_diffuse)
}

time_end <- Sys.time()
time_elapsed <- time_end - time_start

print(paste("Testing", length(LADs), "LAD values")) 
print(time_elapsed)

out_residuals <- dplyr::bind_rows(out_residuals)
```

```{r, fig.dim = c(8, 6)}
best_lad <- out_residuals$lad[which.min(abs(out_residuals$res_pacl))]
text_best_lad <- textGrob(as.character(best_lad),
                          gp=gpar(fontsize=13, fontface="bold",
                                  col = "salmon"))  

ggplot(out_residuals, aes(y = res_pacl, x = lad)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "darkgray") +
  geom_vline(xintercept = best_lad, color = "salmon") +
  annotation_custom(text_best_lad, 
                    xmin=best_lad, xmax=best_lad, 
                    ymin=-0.97, ymax=-0.97) + 
  coord_cartesian(clip = "off") +
  theme_bw() +
  ylab("Residuals between observed and predicted PACL") +
  xlab("Leaf area density LAD")
```


