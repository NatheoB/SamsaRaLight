---
title: "5 - More complex crown shapes"
subtitle: "Represent the crowns with more complex, asymmetric shapes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{5 - More complex crown shapes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This tutorial will explain how to represent the tree crown with more complex shapes. We will use fourth of ellispoid/paraboloid or eighth of ellispoid to represent the asymmetry of crowns. Here, we will base this tutorial on another real inventory: the Bechefa marteloscope, an mixed irregular 


```{r example, message=FALSE, warning=FALSE}
library(SamsaRaLight)
library(dplyr)
library(ggplot2)
library(ggforce)
library(tidyr)
```


# Understand asymmetric crown shapes

## Fourth of an ellispoid/paraboloid

Both the paraboloid ("P") and the ellipsoid ("E") can be represented with more details by splitting the crown into 4 different crown parts. Indeed, we can represent more complex crown shapes with 4 fourth of paraboloids (use the modality "4P" for the `crown_type` column in the tree inventory) or with 4 fourth of ellispoid (use the modality "4E"). Using 4 fourth of a volume allows considering different crown radius between the 4 cardinal directions, that will be provided in the tree inventory using the columns `rn_m` (crown radius toward the north), `rs_m` (crown radius toward the south), `rw_m` (crown radius toward the west), `re_m` (crown radius toward the east).

When the user decides to use the "4P" and "4E" modality, the column `hmax_m` still should not be provided, as the model computes it automatically. As for "P" and "E" simple symmetric crown shapes, it is set to the crown base height ($hmax = hbase$) when considering fourths of paraboloid "4P", and set at the middle of the crown when considering fourths of ellipsoids "4E" ($hmax = h - 0.5*(h - hbase)$).


## Eighth of a paraboloid

The user can also represent an even more complex ellispoidal shape using the modality "8E". It allows representing the crown as an assembly of 8 eighths of ellispoids to consider different heights for the top and bottom crown parts . By doing so, the user must provide the four radius as mentionned above, but must also provide `hmax_m`, which is the height of the maximum crown radius (in meters).


# Provide information for complex crown shapes

In this tutorial, we use "8E" of ellispoids for representing all the crown shapes, whether for broadleaves or conifers species. Indeed, several crown dimensions have been measured on the bechefa marteloscope: crown radius in the four directions (`rn_m`, `rs_m`, `re_m`, `rw_m`), tree height (`h_m`), crown base height (`hbase_m`) and crown maximum radius height (`hmax_m`). This allows to better account for the variability in tree crown shapes and thus better estimate light interception and competition.

```{r}
head(SamsaRaLight::data_bechefa$trees, 20)
```


It is difficult to observe the full crown asymmetry with 2D R plots : we cannot observe different hmax, neither the 4 direction asymmetric radius). A minima, we can represent a two-directionnal radius assymetry by plotting the trees using the `geom_ellipse()` function of the `ggforce` R package, by averaging the north/south radii, and the east/west radii:

```{r plot_stand, fig.dim = c(8, 6)}
ggplot(SamsaRaLight::data_bechefa$trees, 
       aes(fill = species)) +
  # Radius are averaged across south/north and east/west radii
  geom_ellipse(mapping = aes(x0 = x, 
                             y0 = y, 
                             a = (re_m + rw_m) / 2,
                             b = (rn_m + rs_m) / 2,
                             angle = 0)) + 
  coord_equal() +
  theme_bw()
```



# Estimate light interception

For estimating the light interception, it works the same as with simple crowns.

## Create the virtual stand

```{r}
sl_stand <- SamsaRaLight::create_rect_stand(
  trees = SamsaRaLight::data_bechefa$trees,
  cell_size = 5,
  core_polygon_df = SamsaRaLight::data_bechefa$core_polygon,
  fill_around = TRUE
)
```


## Run SamsaraLight

```{r}
sl_out <- SamsaRaLight::sl_run(
  
  # Trees
  trees = sl_stand$trees, 
  
  # Radiations
  monthly_rad = SamsaRaLight::data_bechefa$radiations,
  latitude = SamsaRaLight::data_bechefa$info[["latitude"]], 
  
  # Stand geometry
  slope = SamsaRaLight::data_bechefa$info[["slope"]], 
  aspect = SamsaRaLight::data_bechefa$info[["aspect"]], 
  north_to_x_cw = SamsaRaLight::data_bechefa$info[["north_to_x_cw"]],
  cell_size = sl_stand$info$cell_size, 
  n_cells_x = sl_stand$info$n_cells_x, 
  n_cells_y = sl_stand$info$n_cells_y,
  
  # Transmission model (default is the turbid medium)
  turbid_medium = TRUE,
  
  # Use a torus system for representing plot edges (default to TRUE)
  use_torus = TRUE
  
)
```


# Plot the output stand with irregular crowns

For the sake of representation, we plot here only the inventoried trees by specifying the "trees.only_inv" argument to TRUE. However, the light estimation has been done considering the filled virtual stand and the torus system.

```{r plot_output, fig.dim = c(8, 6)}
plot_sl_output(sl_out, 
               cells.fill = "pacl", 
               cells.fill.palette = "light01",
               trees.only_inv = TRUE)
```

