---
title: "4 - Create a virtual stand from an inventory"
subtitle: "Create an axis-aligned rectangle virtual stand from an inventory of trees"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{4 - Create a virtual stand from an inventory}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This is a tutorial to explain how to create a well formatted SamsaraLight virtual stand from an inventory of trees. At the end of this tutorial, we will better understand how the SamsaraLight model manages the light interception of the trees at the edges of the inventory and the surrounding environment with trees that are not inventoried using a torus system.

```{r example, message=FALSE, warning=FALSE}
library(SamsaRaLight)
library(dplyr)
library(ggplot2)
library(ggforce)
library(tidyr)
library(sf)
```

```{r}
# Set seed for randomization reproducibility
# Needed when filling outside the core polygone (see below)
set.seed(5030)
```

# Inventory info and constraints

In this tutorial, we will use an inventory collected in the scope of the IRRES project, that aims to understand the mechanisms of the transition from even-aged to uneven-aged management. Here, the IRRES1 stand is composed of common spruce and Douglas fir, with a coppice stool of beech at its center and few silver fir and larch trees.


```{r}
head(SamsaRaLight::data_IRRES1$trees)
```


The format and protocol of the inventory here lead us to two new constraints:

1.  The inventory zone appeared to be a rectangle, but is not axis-aligned : we need to an axis-aligned rectangle stand where we include the inventory zone inside.
2.  The coordinates are in a particular coordinate system: we need to convert them into ones relative to the created virtual rectangle stand.


```{r}
ggplot(SamsaRaLight::data_IRRES1$trees, 
       aes(fill = species)) +
  # Radius here are the same across the four cardinals (symmetric crowns)
  geom_circle(mapping = aes(x0 = x, 
                            y0 = y, 
                            r = rn_m)) + 
  coord_equal() +
  theme_bw()
```


# Define the inventory zone

We first need to define the inventory zone by creating a data.frame of vertices. In this tutorial, the IRRES1 as it is a rectangle inventory zone, thus defined by 4 vertices. The core polygon data.frame is stored within the `SamsaRaLight::data_IRRES1` package resource: 


```{r}
SamsaRaLight::data_IRRES1$core_polygon
```


```{r}
ggplot(SamsaRaLight::data_IRRES1$trees, 
       aes(fill = species)) +
  # Radius here are the same across the four cardinals (symmetric crowns)
  geom_circle(mapping = aes(x0 = x, 
                            y0 = y, 
                            r = rn_m)) + 
  coord_equal() +
  theme_bw() +
  
  # Plot the inventory zone
  geom_polygon(data = SamsaRaLight::data_IRRES1$core_polygon, 
               mapping = aes(x = x, y = y), 
               inherit.aes = FALSE,
               fill = "yellow", color = "black", alpha = 0.7)
```


# Create the virtual stand

```{r}
cell_size <- 5
```

After defining the inventory zone with a polygon, we need to include it in an axis-aligned rectangle plot with the coordinates formatted between 0 and the minimum witdth/height including the inventory zone. To do so, the user can use the function `create_rect_stand()` to create the virtual stand and modify the trees and the core polygon coordinates, given a cell size.

```{r}
sl_stand <- create_rect_stand(
  trees = SamsaRaLight::data_IRRES1$trees,
  cell_size = cell_size, 
  core_polygon_df = SamsaRaLight::data_IRRES1$core_polygon
)
```


The output of this function returns a list of different elements : `$trees` which is the updated tree data.frame with shifted coordinates, `$inv_zone_df` which is the updated core polygon data.frame with the shifted coordinates, `$inv_zone_sf` which is the `sf` object corresponding to the core polygon and `$info` is a list with information about the virtual stand creation.

```{r}
str(sl_stand)
```

We can observe the defined inventory zone with the new shifted coordinates: 

```{r}
ggplot(sl_stand$trees, aes(fill = species)) +
  # Radius here are the same across the four cardinals (symmetric crowns)
  geom_circle(mapping = aes(x0 = x, 
                            y0 = y, 
                            r = rn_m)) + 
  coord_equal() +
  theme_bw() +
  geom_sf(data = sl_stand$inv_zone_sf, inherit.aes = FALSE,
          fill = "yellow", color = "black", alpha = 0.7)
  
```

Given in the `$info` output, we see that the inventory zone was about `r sl_stand$info$core_area_ha` hectare ("core_area_ha") with a total basal area of `r sl_stand$info$core_batot_m2ha`$m^2.ha^{-1}$ ("core_batot_m2ha"). The new created virtual stand is now about `r sl_stand$info$new_area_ha` hectare ("new_area_ha") with a total basal area of `r sl_stand$info$new_batot_m2ha`$m^2.ha^{-1}$ ("new_batot_m2ha"), which is necessary lower because we have the same trees in a larger area. The virtual stand is composed of `r sl_stand$info$n_cells_x` cells in the X-axis ("n_cells_x") and `r sl_stand$info$n_cells_y` cells in the Y-axis ("n_cells_y"), with the cell size that was chosen before by the user. Finally, the coordinates has been shifted by `r sl_stand$info$shift_x` meters along the X-axis ("shift_x") and by `r sl_stand$info$shift_y` meters along the Y-axis ("shift_y").

We can use the information from the output of the `create_rect_stand()` to run the SamsaraLight model on the IRRES1 inventory :

```{r}
out_sl <- SamsaRaLight::sl_run(
  # Trees
  trees = sl_stand$trees,

  # Radiations
  monthly_rad = SamsaRaLight::data_IRRES1$radiations,
  latitude = SamsaRaLight::data_IRRES1$info[["latitude"]], 
  
  # Stand geometry
  slope = SamsaRaLight::data_IRRES1$info[["slope"]], 
  aspect = SamsaRaLight::data_IRRES1$info[["aspect"]], 
  north_to_x_cw = SamsaRaLight::data_IRRES1$info[["north_to_x_cw"]],
  cell_size = cell_size, 
  
  # Here, the size of the new axis-aligned rectangle stand are stored in the 
  # output of the create_rect_stand() function
  n_cells_x = sl_stand$info$n_cells_x, 
  n_cells_y = sl_stand$info$n_cells_y,
  
  # Transmission model (default is the turbid medium)
  turbid_medium = TRUE
)
```


We can observe the output light distribution on the ground based on the new created virtual stand :

```{r plot_nofill, fig.dim = c(8, 6)}
plot_sl_output(out_sl, 
               cells.fill = "pacl", 
               cells.fill.palette = "light01")
```


# Fill the virtual stand around the inventory zone

As we can see above, the inventory zone is including on the center of an empty stand. However, running the SamsaraLigth model on this virtual stand will bias the light estimation, as the trees on the edge of the stand may intercept more energies than it should on the field, where there are in fact surrounded by other trees that we were not inventoried. Consequently, light on the ground around the inventory zone appeared to be higher than it would be on the field.

To counteract this constraint, we can mimic a consistent surrounding environment by filling the virtual stand around the inventory zone with trees that composed the inventory, until we reach the total basal area per hectare of the inventory zone. By doing so, the virtual stand can be considered as representative of the inventory zone.


To do so, we can set the argument fill_around to TRUE on the `create_rect_stand()`.

```{r}
sl_stand_filled <- create_rect_stand(
  trees = SamsaRaLight::data_IRRES1$trees,
  cell_size = cell_size, 
  core_polygon_df = SamsaRaLight::data_IRRES1$core_polygon,
  fill_around = TRUE
)
```


We can observe the new created filled axis-aligned rectangle plot :

```{r}
ggplot(sl_stand_filled$trees, aes(fill = species)) +
  # Radius here are the same across the four cardinals (symmetric crowns)
  geom_circle(mapping = aes(x0 = x, 
                            y0 = y, 
                            r = rn_m)) + 
  coord_equal() +
  theme_bw() +
  geom_sf(data = sl_stand_filled$inv_zone_sf, inherit.aes = FALSE,
          fill = "yellow", color = "black", alpha = 0.7)
  
```

We can use the new information from the output of the `create_rect_stand()` to run the SamsaraLight model on the IRRES1 inventory by considering the surrounding environment.

```{r}
out_sl_filled <- SamsaRaLight::sl_run(
  # Trees
  trees = sl_stand_filled$trees, 
  
  # Radiations
  monthly_rad = SamsaRaLight::data_IRRES1$radiations,
  latitude = SamsaRaLight::data_IRRES1$info[["latitude"]], 
  
  # Stand geometry
  slope = SamsaRaLight::data_IRRES1$info[["slope"]], 
  aspect = SamsaRaLight::data_IRRES1$info[["aspect"]], 
  north_to_x_cw = SamsaRaLight::data_IRRES1$info[["north_to_x_cw"]],
  cell_size = cell_size, 
  
  # Here, the size of the new axis-aligned rectangle stand are stored in the 
  # output of the create_rect_stand() function
  n_cells_x = sl_stand_filled$info$n_cells_x, 
  n_cells_y = sl_stand_filled$info$n_cells_y,
  
  # Transmission model (default is the turbid medium)
  turbid_medium = TRUE
)
```


And we can observe the final output light distribution on the ground based on the new created virtual stand. We can fill the trees with a new variables created in the trees dataset from the `create_rect_stand()` (added_to_fill) that is TRUE is the tree was not in the initial inventory and has been added to fill around the core polygon: 

```{r plot_fill, fig.dim = c(8, 6)}
plot_sl_output(out_sl_filled, 
               cells.fill = "pacl", 
               cells.fill.palette = "light01",
               trees.fill = "added_to_fill")
```



# Understanding the torus system

This constraint on the edges of the inventory zone could also be extended to the edges of the rectangle virtual plot. Indeed, how the model represents the surrounding environment of the virtual stand ? 

To do so, the model represents the stand as a torus system (see Courbaud et al. 2003), that looks like a "donuts" form, by virtually gathering the left and the rights edges of the rectangle, and the top and bottom edges together. Specifically, it considers that the trees on the top edges are surrounding by the trees at the bottom edges (and inversely), and that the trees on the left edges are surrounded by the trees on the right edges (and inversely). By doing so, we can consider that trees at any point in the virtual stand are surrounded by trees representative of the stand.  

In the SamsaRaLight R package, the torus system is by default applied with the default argument `use_torus = TRUE` of the `sl_run()` function. We can compare the light on the ground of the IRRES1 inventory with or without applying a torus system. As we can expect, the relative light on the ground is greater on the edges of the virtual stands when the torus system is NOT applied.


```{r}
out_sl_filled_noTorus <- SamsaRaLight::sl_run(
  # Trees
  trees = sl_stand_filled$trees, 
  
  # Radiations
  monthly_rad = SamsaRaLight::data_IRRES1$radiations,
  latitude = SamsaRaLight::data_IRRES1$info[["latitude"]], 
  
  # Stand geometry
  slope = SamsaRaLight::data_IRRES1$info[["slope"]], 
  aspect = SamsaRaLight::data_IRRES1$info[["aspect"]], 
  north_to_x_cw = SamsaRaLight::data_IRRES1$info[["north_to_x_cw"]],
  cell_size = cell_size, 
  
  # Here, the size of the new axis-aligned rectangle stand are stored in the 
  # output of the create_rect_stand() function
  n_cells_x = sl_stand_filled$info$n_cells_x, 
  n_cells_y = sl_stand_filled$info$n_cells_y,
  
  # Transmission model (default is the turbid medium)
  turbid_medium = TRUE,
  
  # Use a torus system for representing plot edges (default to TRUE)
  use_torus = FALSE
)
```


## With a torus system

```{r plot_fill_torus, fig.dim = c(8, 6)}
plot_sl_output(out_sl_filled, 
               cells.fill = "pacl", 
               cells.fill.palette = "light01",
               trees.fill = NULL)
```


## Without the torus system

```{r plot_fill_notorus, fig.dim = c(8, 6)}
plot_sl_output(out_sl_filled_noTorus, 
               cells.fill = "pacl", 
               cells.fill.palette = "light01",
               trees.fill = NULL)
```
