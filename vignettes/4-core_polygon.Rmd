---
title: "Tutorial 4 - Core polygon"
subtitle: "Create a rectangle plot from a polygonial inventory of trees"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Tuto4 - core polygon}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  ---
  

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)
```


```{r example, message=FALSE, warning=FALSE}
library(SamsaRaLight)
library(dplyr)
library(ggplot2)
library(ggforce)
library(tidyr)
library(sf)
```


```{r}
# Set seed for randomization reproducibility
set.seed(5030)
```


# Inventory info

```{r stand_geom}
# It is an uneven-aged mixed stand in Belgium with irregular crowns
data_trees <- SamsaRaLight::data_trees_bechefa

# Coordinates of the stand (for monthly radiation and rays geometry)
latitude <- 50.04 # The latitude of the stand (Y-coord in WGS85)
longitude <- 5.2 # The longitude of the plot (X-coord in WGS85)

# The slope of the stand
slope <- 0

# Angle of slope bottom on the compass from the North, clockwise rotation (in degrees)
# northern aspect : 0, eastern aspect : 90, southern aspect : 180, western aspect : 270
aspect <- 0

# Angle from North to x axis clockwise. (in degrees)
# Default value 90 corresponds to a Y axis oriented toward the North.
north_to_x_cw <- 90
```


# Define the rectangal square

```{r}
cell_size <- 10
n_cells_x <- 20
n_cells_y <- 15
```


# Run SamsaraLight on the unfilled plot


```{r data_trees}
data_monthly_rad <- SamsaRaLight::get_monthly_rad(latitude, longitude)

out <- SamsaRaLight::sl_run(
  data_trees, data_monthly_rad,
  latitude = latitude, slope = slope, 
  aspect = aspect, north_to_x_cw = north_to_x_cw,
  cell_size = cell_size, 
  n_cells_x = n_cells_x, n_cells_y = n_cells_y,
  turbid_medium = TRUE,
  trunk_interception = FALSE
)
```

Crown representation are the maximum radius between the two cardinals of a given axis.

```{r output_sl, fig.dim = c(8, 6)}
plot_inv <- out$cells %>% 
  dplyr::mutate(
    pacl_group = case_when(
      pacl_slope > 0.5 ~ "> 50%",
      pacl_slope > 0.25 ~ "25 - 50%",
      pacl_slope > 0.125 ~ "12.5 - 25%",
      pacl_slope > 0.0625 ~ "6.25 - 12.5%",
      pacl_slope <= 0.0625 ~ "< 6.25%"
    ),
    pacl_group = factor(pacl_group,
                        levels = c("< 6.25%", "6.25 - 12.5%",
                                   "12.5 - 25%", "25 - 50%",
                                   "> 50%"))) %>% 
  
  ggplot() +
  
  geom_tile(aes(x = x_center, y = y_center,
                fill = pacl_group), color = "black") +
  scale_fill_grey(start = 0.2, end = 1,
                  drop = FALSE) +
  labs(fill = "Cells enlightment") +
  ggnewscale::new_scale_fill() +
  
  geom_ellipse(data = data_trees, mapping = aes(x0 = x, y0 = y, 
                                                a = (re_m + rw_m) / 2,
                                                b = (rn_m + rs_m) / 2,
                                                angle = 0,
                                                fill = species)) +
  coord_equal() +
  labs(fill = "Species") +
  scale_fill_manual(values = c("skyblue", "salmon", "olivedrab3", "mediumorchid1")) +
  
  scale_x_continuous(breaks = seq(0, n_cells_x*cell_size,
                                  by = cell_size),
                     labels = round(seq(0, n_cells_x*cell_size,
                                        by = cell_size),
                                    digits = 1)) +
  scale_y_continuous(breaks = seq(0, n_cells_y*cell_size,
                                  by = cell_size),
                     labels = round(seq(0, n_cells_y*cell_size,
                                        by = cell_size),
                                    digits = 1)) +
  
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        legend.position = "right") +
  xlab("") + ylab("")

plot_inv
```

# Simple polygon in a given data.frame

```{r, fig.dim = c(8, 6)}
core_polygon <- data.frame(x = c(0, 171.5, 200, 28.5), y = c(70.5, 139.8, 69.3, 0))

inv_filled_simplePolygon <- SamsaRaLight::fill_square_inventory(data_trees, 
                                                                cell_size, n_cells_x, n_cells_y,
                                                                core_polygon)

plot_inv_simplePolygon  <- plot_inv +
  geom_sf(data = inv_filled_simplePolygon$core_polygon, 
          inherit.aes = FALSE,
          fill = "yellow", color = "black", alpha = 0.7)

plot_inv_simplePolygon
```


# Find a polygon that encompasses all the trees and fill outside with equivalent trees

```{r}
inv_filled <- SamsaRaLight::fill_square_inventory(data_trees, 
                                                  cell_size, n_cells_x, n_cells_y)
```

```{r output_polygon, fig.dim = c(8, 6)}
plot_inv_polygon <- plot_inv +
  geom_sf(data = inv_filled$core_polygon, inherit.aes = FALSE,
          fill = "yellow", color = "black", alpha = 0.7)

plot_inv_polygon
```

```{r output_polygon_filled, fig.dim = c(8, 6)}
plot_inv_polygon_fill <- plot_inv_polygon + 
  geom_ellipse(data = inv_filled$new_inventory %>% dplyr::filter(added_to_fill), 
               mapping = aes(x0 = x, y0 = y, 
                             a = (re_m + rw_m) / 2,
                             b = (rn_m + rs_m) / 2,
                             angle = 0,
                             fill = species)) 

plot_inv_polygon_fill
```

```{r}
sprintf("Bechefa area is %f ha with a total basal area of %f m2/ha",
        inv_filled$info$core_area_ha, inv_filled$info$core_batot_m2ha)

sprintf("%i trees added to the initial inventory, for a total basal area of %f m2/ha",
        inv_filled$info$n_added_tree, inv_filled$info$new_batot_m2ha)
```



# Run SamsaraLight on the filled plot

```{r  output_sl_filled, fig.dim = c(8, 6)}
out_filled <- SamsaRaLight::sl_run(
  inv_filled$new_inventory, data_monthly_rad,
  latitude = latitude, slope = slope, 
  aspect = aspect, north_to_x_cw = north_to_x_cw,
  cell_size = cell_size, 
  n_cells_x = n_cells_x, n_cells_y = n_cells_y,
  turbid_medium = TRUE,
  trunk_interception = FALSE
)

plot_inv_filled <- out_filled$cells %>% 
  dplyr::mutate(
    pacl_group = case_when(
      pacl_slope > 0.5 ~ "> 50%",
      pacl_slope > 0.25 ~ "25 - 50%",
      pacl_slope > 0.125 ~ "12.5 - 25%",
      pacl_slope > 0.0625 ~ "6.25 - 12.5%",
      pacl_slope <= 0.0625 ~ "< 6.25%"
    ),
    pacl_group = factor(pacl_group,
                        levels = c("< 6.25%", "6.25 - 12.5%",
                                   "12.5 - 25%", "25 - 50%",
                                   "> 50%"))) %>% 
  
  ggplot() +
  
  geom_tile(aes(x = x_center, y = y_center,
                fill = pacl_group), color = "black") +
  scale_fill_grey(start = 0.2, end = 1,
                  drop = FALSE) +
  labs(fill = "Cells enlightment") +
  ggnewscale::new_scale_fill() +
  
  geom_ellipse(data = inv_filled$new_inventory, 
               mapping = aes(x0 = x, y0 = y, 
                             a = (re_m + rw_m) / 2,
                             b = (rn_m + rs_m) / 2,
                             angle = 0,
                             fill = species)) +
  coord_equal() +
  labs(fill = "Species") +
  scale_fill_manual(values = c("skyblue", "salmon", "olivedrab3", "mediumorchid1")) +
  
  scale_x_continuous(breaks = seq(0, n_cells_x*cell_size,
                                  by = cell_size),
                     labels = round(seq(0, n_cells_x*cell_size,
                                        by = cell_size),
                                    digits = 1)) +
  scale_y_continuous(breaks = seq(0, n_cells_y*cell_size,
                                  by = cell_size),
                     labels = round(seq(0, n_cells_y*cell_size,
                                        by = cell_size),
                                    digits = 1)) +
  
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        legend.position = "right") +
  xlab("") + ylab("")

plot_inv_filled
```
