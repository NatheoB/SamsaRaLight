---
title: "Tuto3 - irregular crowns"
subtitle: "Compute tree light interception with irregular tree crowns"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Tuto3 - irregular crowns}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This is a basic example which shows you how to solve a common problem:

```{r example, message=FALSE, warning=FALSE}
library(SamsaRaLight)
library(dplyr)
library(ggplot2)
library(ggforce)
library(tidyr)
```


# Inputs

## Set the stand geometry

You first need to precise the geometry of the stand with:

```{r stand_geom}
# Coordinates of the stand (for monthly radiation and rays geometry)
latitude <- 50.04 # The latitude of the stand (Y-coord in WGS85)
longitude <- 5.2 # The longitude of the plot (X-coord in WGS85)

# The slope of the stand
slope <- 0

# Angle of slope bottom on the compass from the North, clockwise rotation (in degrees)
# northern aspect : 0, eastern aspect : 90, southern aspect : 180, western aspect : 270
aspect <- 0

# Angle from North to x axis clockwise. (in degrees)
# Default value 90 corresponds to a Y axis oriented toward the North.
north_to_x_cw <- 90

# Considering a squared plot, number and size of the cells composing the grid
n_cells_x <- 20 # Number of cells columns
n_cells_y <- 15 # Number of cells rows
cell_size <- 10 # Size of the length of a cell
```


## Trees description

You can find an example tree dataset
`SamsaRaLight::data_trees_bechefa`. It is an uneven-aged mixed stand in Belgium.
We will use 8 eighth of ellipsoids to represent irregular crowns. 

```{r data_trees}
data_trees <- SamsaRaLight::data_trees_bechefa
head(data_trees)
summary(data_trees)
```


## Monthly radiation

Monthly radiation for Prenovel example is stored within the package using `SamsaRaLight::data_rad_bechefa`.
The dataset is fetched using the above function:

```{r monthly_rad}
data_monthly_rad <- SamsaRaLight::get_monthly_rad(latitude, longitude)
data_monthly_rad
```



# Run SamsaRaLight

Now, given the stand geometry, the trees dataset and the monthly
radiation, you can run SamsaRaLight using the function `sl_run()`.

```{r out_sl}
out <- SamsaRaLight::sl_run(
    data_trees, data_monthly_rad,
    latitude = latitude, slope = slope, 
    aspect = aspect, north_to_x_cw = north_to_x_cw,
    cell_size = cell_size, 
    n_cells_x = n_cells_x, n_cells_y = n_cells_y,
    turbid_medium = TRUE,
    trunk_interception = FALSE
  )
```


```{r time_sl, echo=FALSE}
microbenchmark::microbenchmark(
  "sl" = SamsaRaLight::sl_run(
    data_trees, data_monthly_rad,
    latitude = latitude, slope = slope, 
    aspect = aspect, north_to_x_cw = north_to_x_cw,
    cell_size = cell_size, 
    n_cells_x = n_cells_x, n_cells_y = n_cells_y,
    turbid_medium = TRUE,
    trunk_interception = FALSE
  ))
```


# Outputs

## Tree light interception

```{r output_trees, fig.dim = c(8, 6)}
out$trees %>% 
  tidyr::pivot_longer(!id_tree, names_to = "var") %>%
  dplyr::left_join(data_trees, by = "id_tree") %>% 

  ggplot(aes(y = value, x = dbh_cm, color = species)) +
  facet_wrap(~var) +
  geom_point() +
  theme(legend.position = "top") +
  scale_color_manual(values = c("skyblue", "salmon", "olivedrab3", "mediumorchid1"))
```


## Light on the ground

Crown representation are the maximum radius between the two cardinals of a given axis.

```{r output_ground, fig.dim = c(8, 6)}
out$cells %>% 
  dplyr::mutate(
    erel_group = case_when(
      erel > 0.5 ~ "> 50%",
      erel > 0.25 ~ "25 - 50%",
      erel > 0.125 ~ "12.5 - 25%",
      erel > 0.0625 ~ "6.25 - 12.5%",
      erel <= 0.0625 ~ "< 6.25%"
    ),
    erel_group = factor(erel_group,
                        levels = c("< 6.25%", "6.25 - 12.5%",
                                   "12.5 - 25%", "25 - 50%",
                                   "> 50%"))) %>% 

ggplot() +
  
  geom_tile(aes(x = x_center, y = y_center,
                fill = erel_group), color = "black") +
  scale_fill_grey(start = 0.2, end = 1,
                  drop = FALSE) +
  labs(fill = "Cells enlightment") +
  ggnewscale::new_scale_fill() +
  
  geom_ellipse(data = data_trees, mapping = aes(x0 = x, y0 = y, 
                                               a = max(re_m, rw_m),
                                               b = max(rn_m, rs_m),
                                               angle = 0,
                                               fill = species)) +
  coord_equal() +
  labs(fill = "Species") +
  scale_fill_manual(values = c("skyblue", "salmon", "olivedrab3", "mediumorchid1")) +
  
  scale_x_continuous(breaks = seq(0, n_cells_x*cell_size,
                                  by = cell_size),
                     labels = round(seq(0, n_cells_x*cell_size,
                                        by = cell_size),
                                    digits = 1)) +
  scale_y_continuous(breaks = seq(0, n_cells_y*cell_size,
                                  by = cell_size),
                     labels = round(seq(0, n_cells_y*cell_size,
                                        by = cell_size),
                                    digits = 1)) +
  
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        legend.position = "right") +
  xlab("") + ylab("")
```

```{r output_ground_only, fig.dim = c(8, 6)}
out$cells %>% 
  dplyr::mutate(
    erel_group = case_when(
      erel > 0.5 ~ "> 50%",
      erel > 0.25 ~ "25 - 50%",
      erel > 0.125 ~ "12.5 - 25%",
      erel > 0.0625 ~ "6.25 - 12.5%",
      erel <= 0.0625 ~ "< 6.25%"
    ),
    erel_group = factor(erel_group,
                        levels = c("< 6.25%", "6.25 - 12.5%",
                                   "12.5 - 25%", "25 - 50%",
                                   "> 50%"))) %>% 

ggplot() +
  
  geom_tile(aes(x = x_center, y = y_center,
                fill = erel_group), color = "black") +
  scale_fill_grey(start = 0.2, end = 1,
                  drop = FALSE) +
  labs(fill = "Cells enlightment") +
  
  scale_x_continuous(breaks = seq(0, n_cells_x*cell_size,
                                  by = cell_size),
                     labels = round(seq(0, n_cells_x*cell_size,
                                        by = cell_size),
                                    digits = 1)) +
  scale_y_continuous(breaks = seq(0, n_cells_y*cell_size,
                                  by = cell_size),
                     labels = round(seq(0, n_cells_y*cell_size,
                                        by = cell_size),
                                    digits = 1)) +
  
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        legend.position = "right") +
  xlab("") + ylab("")
```