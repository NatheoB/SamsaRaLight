---
title: "Tutorial 1"
subtitle: "Compute tree light interception with simple symmetric crowns"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Tuto1 - symetric crowns}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This is a basic example which shows you how to solve a common problem:

```{r example, message=FALSE, warning=FALSE}
library(SamsaRaLight)
library(dplyr)
library(ggplot2)
library(ggforce)
library(tidyr)
```


# Inputs

## Set the stand geometry

You first need to precise the geometry of the stand with:

```{r stand_geom}
# Coordinates of the stand (for monthly radiation and rays geometry)
latitude <- 46 # The latitude of the stand (Y-coord in WGS85)
longitude <- 2 # The longitude of the plot (X-coord in WGS85)

# The slope of the stand
slope <- 6

# Angle of slope bottom on the compass from the North, clockwise rotation (in degrees)
# northern aspect : 0, eastern aspect : 90, southern aspect : 180, western aspect : 270
aspect <- 144

# Angle from North to x axis clockwise. (in degrees)
# Default correspond to a Y axis oriented toward the North.
north_to_x_cw <- 54

# Considering a squared plot, number and size of the cells composing the grid
n_cells_x <- 10 # Number of cells columns
n_cells_y <- 10 # Number of cells rows
cell_size <- 10 # Size of the length of a cell
```


## Trees description

You can find an example tree dataset
`SamsaRaLight::data_trees_prenovel`. It is an uneven-aged mountain stand
of fir, spruce, beech located in Prenovel (Jura, France).

```{r data_trees}
data_trees <- SamsaRaLight::data_trees_prenovel %>%
  dplyr::mutate(rn_m = r_m,
                re_m = r_m,
                rs_m = r_m,
                rw_m = r_m,
                crown_lad = case_match(species,
                                       c("Picea abies", "Abies alba") ~ 0.767,
                                       "Fagus sylvatica" ~ 0.96),
                crown_type = case_match(species,
                                        c("Picea abies", "Abies alba") ~ "P",
                                        "Fagus sylvatica" ~ "E"),
                hmax_m = NA)

head(data_trees)
```


## Monthly radiation

Monthly radiation for Prenovel example is stored within the package using `SamsaRaLight::data_rad_prenovel`.
The dataset is fetched using the above function.

```{r monthly_rad}
data_monthly_rad <- SamsaRaLight::get_monthly_rad(latitude, longitude)
data_monthly_rad
```



# Run SamsaRaLight

Now, given the stand geometry, the trees dataset and the monthly
radiation, you can run SamsaRaLight using the function `sl_run()`.

```{r out_sl}
out <- SamsaRaLight::sl_run(
    data_trees, data_monthly_rad,
    latitude = latitude, slope = slope, 
    aspect = aspect, north_to_x_cw = north_to_x_cw,
    cell_size = cell_size, 
    n_cells_x = n_cells_x, n_cells_y = n_cells_y,
    turbid_medium = TRUE,
    trunk_interception = FALSE
  )
```


```{r time_sl, echo=FALSE}
microbenchmark::microbenchmark(
  "sl" = SamsaRaLight::sl_run(
    data_trees, data_monthly_rad,
    latitude = latitude, slope = slope, 
    aspect = aspect, north_to_x_cw = north_to_x_cw,
    cell_size = cell_size, 
    n_cells_x = n_cells_x, n_cells_y = n_cells_y,
    turbid_medium = TRUE,
    trunk_interception = FALSE
  ))
```


# Outputs

## Tree light interception

```{r, output_trees}
out$trees %>% 
  tidyr::pivot_longer(!id_tree, names_to = "var") %>%
  dplyr::left_join(data_trees, by = "id_tree") %>% 

  ggplot(aes(y = value, x = dbh_cm, color = species)) +
  facet_wrap(~var) +
  geom_point() +
  theme(legend.position = "top")
```


## Light on the ground

```{r, output_ground}
out$cells %>% 
  dplyr::mutate(
    erel_group = case_when(
      erel > 0.5 ~ "> 50%",
      erel > 0.25 ~ "25 - 50%",
      erel > 0.125 ~ "12.5 - 25%",
      erel > 0.0625 ~ "6.25 - 12.5%",
      erel <= 0.0625 ~ "< 6.25%"
    ),
    erel_group = factor(erel_group,
                        levels = c("< 6.25%", "6.25 - 12.5%",
                                   "12.5 - 25%", "25 - 50%",
                                   "> 50%"))) %>% 

ggplot() +
  
  geom_tile(aes(x = x_center, y = y_center,
                fill = erel_group), color = "black") +
  scale_fill_grey(start = 0.2, end = 1,
                  drop = FALSE) +
  labs(fill = "Cells enlightment") +
  ggnewscale::new_scale_fill() +
  
  geom_circle(data = data_trees, mapping = aes(x0 = x, y0 = y, r = r_m, fill = species)) +
  coord_equal() +
  labs(fill = "Species") +
  
  scale_x_continuous(breaks = seq(0, n_cells_x*cell_size,
                                  by = cell_size),
                     labels = round(seq(0, n_cells_x*cell_size,
                                        by = cell_size),
                                    digits = 1)) +
  scale_y_continuous(breaks = seq(0, n_cells_y*cell_size,
                                  by = cell_size),
                     labels = round(seq(0, n_cells_y*cell_size,
                                        by = cell_size),
                                    digits = 1)) +
  
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        legend.position = "right") +
  xlab("") + ylab("")
```

